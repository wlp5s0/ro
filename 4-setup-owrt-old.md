# Настройка роутера на OpenWRT


> [!IMPORTANT]  
> Перед настройкой требуется отключить провод провайдера от роутера и компьютера. На компьютере нужно отключить Проверку подлинности, если она была настроена.

Настройка роутеров с прошивкой OpenWRT и маломощным железом. Это роутеры с OpenWRT версий 18, 19 и более ранними. Как правило, однодиапазонные TP-Link.

## 1. Вход в WEB-интерфейс

Настройка производится в WEB-интерфейсе роутера, доступном без подключения к интернету. 

Для этого подключаем роутер к ПК по проводу либо по Wi-Fi, если сеть уже настроена. В браузере в адресной строке необходимо открыть адрес `http://192.168.1.1/` либо `http://openwrt.lan/`. 

<p align="center">
<img src="img/owrt/image25.png">
</p>

Аккаунт `root` без пароля. Позднее его можно установить на вкладке System - Administration.

<p align="center">
<img src="img/owrt-old/1.png">
</p>

Интерфейс LuCI для ОС OpenWRT на маломощных роутерах выглядит так или схожим образом.


<p align="center">
<img src="img/owrt-old/13.png">
</p>

## 2. Подмена MAC адреса

__[Как узнать MAC адрес и какой мне нужен](./6-macaddr.md) - помощь__

Подмена MAC-адреса интерфейса WAN осуществляется в случае, **если ранее производилось подключение** с другого устройства - через проводное подключение с настройкой проверки подлинности либо беспроводную сеть MIET-DP. **Иначе этот шаг можно пропустить.**

В интерфейсе переходим на вкладку Network - Interfaces.


<p align="center">
<img src="img/owrt-old/5.png">
</p>

Нас интересует строчка с интерфейсом WAN. Переходим в настройки интерфейса нажатием на `Edit`.

<p align="center">
<img src="img/owrt-old/6.png">
</p>

Откроется окно с настройкой интерфейса WAN, на котором выбираем Advanced Settings.

<p align="center">
<img src="img/owrt-old/7.png">
</p>

Внизу будет параметр `Override MAC address`.

<p align="center">
<img src="img/owrt-old/8.png">
</p>

Узнаём MAC адрес устройства, на котором ранее осуществлялось подключение.

__[Как узнать MAC адрес и какой мне нужен](./6-macaddr.md) - помощь__

Вписываем этот MAC-адрес на место поля `Override MAC address`, как указано на скриншоте.

Применяем настройки, нажав Save & Apply.

## 3. Настройка Wi-Fi

Переходим на страницу __Network - Wireless__.

Здесь представлен интерфейс radio0 и созданная под ним сеть OpenWRT. Редактируем её нажатием на Edit.

<p align="center">
<img src="img/owrt-old/9.png">
</p>

Откроется окно редактирования сети.

<p align="center">
<img src="img/owrt-old/10.png">
</p>

В нижней половине в разделе Interface Configuration доступны параметры точки доступа. Здесь мы редактируем:

__3.1. Название сети__

Параметр ESSID в General Setup отвечает за название сетию

<p align="center">
<img src="img/owrt-old/11.png">
</p>

__3.2. Пароль и шифрование сети__

Указываем Encryption `WPA2-PSK` и пароль для точки доступа в Key.

<p align="center">
<img src="img/owrt-old/12.png">
</p>

__3.3. Применение настроек__

Можно сразу включить сеть нажав на Enable в верхней половине:

<p align="center">
<img src="img/owrt-old/15.png">
</p>

Либо нажать Save&Apply, затем нажать Enable на общем экране, там, где была синяя Edit.

<p align="center">
<img src="img/owrt-old/14.png">
</p>

## 4. Настройка времени

На вкладке System – System нажимаем Sync with browser рядом с полем текущего времени. Оно может отличаться от системного на 3 часа, как правило, не играет роли. Достаточно, чтобы совпадала дата.

<p align="center">
<img src="img/owrt-old/3.png">
</p>

<p align="center">
<img src="img/owrt-old/4.png">
</p>

Точно так же сохраняем настройки через Save & Apply.

## 5. Настройка авторизации в сети МИЭТ
На вкладке MIET (в ранних версиях модуля – Interfaces – mschapv2) устанавливаем логин и пароль от ОРИОКС.
Сохраняем кнопкой Save.

<p align="center">
<img src="img/owrt-old/2.png">
</p>

__Start on boot [Disable]__ отвечает за автозапуск сервиса авторизации при включении роутера, должен быть красным.

__Kill process__ позволяет отключить или запустить сервис авторизации вручную.

__Заметка__. Если любое действие на вкладке выпадает в ошибку, это старая версия модуля и настраивается ручками [по инструкции, раздел 802.1x](./4-setup-owrt-cli.md), а вообще стоит обратиться к автору гита для обновления на прошивку с починенным багом.

## 6. Перезагрузка

Чтобы все норм заработало, перезагружаем роутер.

## Диагностика

Заходим на вкладку 192.168.1.1 Network - Interfaces. Смотрим на WAN.

<p align="center"><img src="img/owrt/1.png"></p>

__На интерфейсе RX: 0 B (0 Pkts)__ - провод не подключен или неисправен. 
[Как найти провод от провайдера и определить рабочий](./6-wire.md). Еще можно проверять статус через Network - Switch, там отображается статус портов.

<p align="center"><img src="img/owrt/2.png"></p>

**На интерфейсе RX и TX больше 0**, но не появляются строки Uptime и IPv4. Значит нужно проверить:

* Дату (system system)
* Корректность введённых данных в MIET (mschapv2).
* Включенность сервиса авторизации там же (кнопки красные).
* Логи авторизации там же (о них чуть ниже)

<p align="center"><img src="img/owrt/3.png">< /p>

**На интерфейсе есть IPv4**

Ура!

* Если вы еще не подключали тариф, то всё хорошо, и есть смысл идти дальше - к регистрации у провайдера и подключению тарифа. Ориокс загрузится уже сейчас.
* Если тариф подключался, но сейчас интернета нет - указан неверный MAC адрес.
* Если тариф подключался, и интернет есть - всё тоже отлично.

## Про логи на вкладке MIET

Если `Selected interface 'global'`, то сервис авторизации не запущен. Для этого стоит убедиться, что кнопки на владке MIET красные, а если зеленые - запустить.

Если `Selected interface 'eth0.2'` то смотрим:

    EAP state=SUCCESS - всё хорошо
    EAP state=IDLE - безуспешно пытается авторизоваться
    EAP state=FAILURE - все точно плохо

## Нестандартные случаи

Авторизация на владке MIET успешна, IPv4 не появляется:
* либо лежат сервера миэта
* либо попробуйте с учеткой соседа
* либо пишите в онплюс они умеют это чинить

[Следующий шаг: Проверка подключения](./3-check.md)